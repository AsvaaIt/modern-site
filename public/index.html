<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Visitor Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { padding: 8px; border: 1px solid #ccc; text-align: left; }
    th { background: #f0f0f0; }
    #map { height: 500px; width: 100%; }
  </style>
</head>
<body>
  <h1>Real-time Visitor Dashboard</h1>

  <table>
    <thead>
      <tr>
        <th>Timestamp</th>
        <th>IP</th>
        <th>Country</th>
        <th>City</th>
        <th>Browser</th>
        <th>OS</th>
        <th>Device</th>
        <th>URL</th>
      </tr>
    </thead>
    <tbody id="visitor-table"></tbody>
  </table>

  <div id="map"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const socket = io(); // Connect to backend
    const tbody = document.getElementById("visitor-table");

    // Initialize Leaflet map
    const map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    socket.on("new-visitor", (visitor) => {
      // Add visitor to table
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${visitor.timestamp}</td>
        <td>${visitor.ip}</td>
        <td>${visitor.country}</td>
        <td>${visitor.city}</td>
        <td>${visitor.browser}</td>
        <td>${visitor.os}</td>
        <td>${visitor.device}</td>
        <td>${visitor.url}</td>
      `;
      tbody.prepend(row);

      // Plot visitor on map
      if(visitor.geo && visitor.geo.ll) {
        const [lat, lon] = visitor.geo.ll;
        L.marker([lat, lon])
          .addTo(map)
          .bindPopup(`<b>${visitor.ip}</b><br>${visitor.city || ''}, ${visitor.country || ''}`);
      }
    });
  </script>
</body>
</html>
